<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Actor Cards</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <a href="#main" class="skip-link">Skip to main content</a>

  <div class="container py-4">
    <header class="mb-3" role="banner">
      <div class="d-flex align-items-center gap-3">
        <img src="img/pt-bw-round@2x.png" alt="Powell Talent" class="header-logo">
        <div class="flex-fill">
          <h1 class="h3 mb-1">Actor Travel Cards</h1>
          <p class="mb-2 small text-muted">From CSV: Actors_Full_Details for cards.csv</p>
          <nav aria-label="Primary">
            <ul class="nav nav-pills">
              <li class="nav-item"><a class="nav-link rounded-pill" href="index.html">Home</a></li>
              <li class="nav-item"><a class="nav-link rounded-pill active" aria-current="page" href="cards.html">Travel</a></li>
              <li class="nav-item"><a class="nav-link rounded-pill" href="funkos.html">Pops</a></li>
            </ul>
          </nav>
        </div>
      </div>
    </header>

    <main id="main" role="main" aria-label="Actor Cards">
      <div class="row mb-3 g-2 align-items-center">
        <div class="col-12 col-md-6">
          <label class="visually-hidden" for="filter">Filter actors</label>
          <input id="filter" class="form-control" type="search" placeholder="Type to filter by name…" />
        </div>
        <div class="col-12 col-md-6 text-md-end">
          <span id="count" class="text-muted small">Loading…</span>
        </div>
      </div>

      <section id="grid" class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-3" aria-live="polite" aria-busy="true"></section>
    </main>
  </div>

  <script>
  // --- Utility: simple RFC4180 CSV parser (handles quoted newlines) ---
  function parseCSV(text){
    const rows = [];
    let row = [];
    let field = '';
    let inQuotes = false;
    for(let i=0;i<text.length;i++){
      const c = text[i];
      if(c === '"'){
        if(inQuotes && text[i+1] === '"'){
          field += '"'; i++; // escaped quote
        } else {
          inQuotes = !inQuotes;
        }
      } else if(c === ',' && !inQuotes){
        row.push(field); field = '';
      } else if((c === '\n' || c === '\r') && !inQuotes){
        // finalize field and row; swallow CRLF
        row.push(field); field = '';
        if(row.some(cell => cell !== '')) rows.push(row);
        row = [];
        if(c === '\r' && text[i+1] === '\n') i++;
      } else {
        field += c;
      }
    }
    // flush last field/row
    if(field !== '' || row.length){
      row.push(field);
      if(row.some(cell => cell !== '')) rows.push(row);
    }
    return rows;
  }

  function toObjects(rows){
    if(!rows.length) return [];
    const header = rows[0].map(h => (h||'').trim());
    const out = [];
    for(let i=1;i<rows.length;i++){
      const r = rows[i];
      const obj = {};
      header.forEach((key, idx) => { obj[key] = (r[idx] ?? '').trim(); });
      out.push(obj);
    }
    return out;
  }

  function esc(str){
    return String(str||'')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;');
  }
  function escAttr(str){
    return esc(str).replace(/\"/g,'&quot;').replace(/'/g,'&#39;');
  }
  function normName(s){
    return String(s||'')
      .toLowerCase()
      .normalize('NFKD')
      .replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-z0-9]+/g,' ')
      .trim();
  }
  function canonicalActorKey(name){
    const suffixes = new Set(['jr','sr','ii','iii','iv','v']);
    const tokens = normName(name).split(' ').filter(Boolean);
    const out = [];
    for(let i=0;i<tokens.length;i++){
      const t = tokens[i];
      if(suffixes.has(t)) continue; // drop suffixes
      // drop single-letter middle initials; keep if first or last token
      if(t.length === 1 && i>0 && i<tokens.length-1) continue;
      out.push(t);
    }
    return out.join(' ');
  }
  function copyText(text){
    if(navigator.clipboard && window.isSecureContext){
      return navigator.clipboard.writeText(text);
    }
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    let ok = false;
    try { ok = document.execCommand('copy'); } catch(e){}
    document.body.removeChild(ta);
    return ok ? Promise.resolve() : Promise.reject(new Error('Clipboard not available'));
  }

  // Merge duplicate actors by canonical name (ignores middle initials/suffixes)
  function mergeByActor(list){
    const keyName = 'Professional Name';
    const map = new Map(); // key: canonical name -> merged object
    for(const item of list){
      const profName = (item[keyName]||'').trim();
      if(!profName) continue;
      const key = canonicalActorKey(profName);
      if(!key) continue;
      if(!map.has(key)){
        map.set(key, { ...item });
      } else {
        const acc = map.get(key);
        // Prefer a shorter, cleaner professional name if existing is longer with middle initial
        const currentName = (acc[keyName]||'').trim();
        if(currentName && profName && profName.length < currentName.length){
          acc[keyName] = profName;
        }
        for(const k of Object.keys(item)){
          if(k === keyName) continue;
          const a = (acc[k]||'').trim();
          const b = (item[k]||'').trim();
          if(!b) continue;
          if(!a){ acc[k] = b; continue; }
          if(a.includes(b)) continue; // already has
          // combine intelligently: multiline fields get blank line, others a separator
          if(/panel/i.test(k)){
            acc[k] = a + "\n\n" + b;
          } else {
            acc[k] = a + " | " + b;
          }
        }
      }
    }
    return Array.from(map.values()).sort((a,b)=>a['Professional Name'].localeCompare(b['Professional Name']));
  }

  function render(cards){
    const grid = document.getElementById('grid');
    const count = document.getElementById('count');
    const html = cards.map(card => {
      const nameRaw = String(card['Professional Name'] || '');
      const name = esc(nameRaw);
      const legal = esc(card['Legal Name']);
      const dob = esc(card['Date of Birth']);
      const tsa = esc(card['TSA PreCheck® KTN']);
      const travelRaw = String(card['Travel Preferences']||'');
      const travelLimit = (normName(nameRaw) === 'spike spencer') ? 24 : 48;
      const travelEsc = esc(travelRaw);
      const travelIsLong = travelRaw.length > travelLimit;
      const travelTrunc = travelIsLong ? esc(travelRaw.slice(0,travelLimit).trimEnd()) + '…' : travelEsc;
      const dietRaw = String(card['Food Allergies, Dietary Needs.']||'');
      const dietEsc = esc(dietRaw);
      const dietIsLong = dietRaw.length > 48;
      const dietTrunc = dietIsLong ? esc(dietRaw.slice(0,48).trimEnd()) + '…' : dietEsc;
      const panelsRaw = String(card['Panels and Workshops']||'');
      const panels = esc(panelsRaw).replace(/\n/g,'<br>');

      const meta = [];
      if(legal) meta.push(`<div><span class="text-secondary">Legal:</span> ${legal}</div>`);
      if(dob)   meta.push(`<div><span class="text-secondary">DOB:</span> ${dob}</div>`);
      if(tsa)   meta.push(`<div><span class="text-secondary">TSA KTN:</span> ${tsa}</div>`);
      if(travelRaw){
        if(travelIsLong){
          meta.push(`<div><span class="text-secondary">Travel:</span> <span class="travel" data-full="${escAttr(travelRaw)}">${travelTrunc}</span> <a href="#" class="small js-read-more">read more</a></div>`);
        } else {
          meta.push(`<div><span class="text-secondary">Travel:</span> ${travelEsc}</div>`);
        }
      }
      if(dietRaw){
        if(dietIsLong){
          meta.push(`<div><span class="text-secondary">Diet:</span> <span class="diet" data-full="${escAttr(dietRaw)}">${dietTrunc}</span> <a href="#" class="small js-read-more">read more</a></div>`);
        } else {
          meta.push(`<div><span class="text-secondary">Diet:</span> ${dietEsc}</div>`);
        }
      }

      // Build plain-text payload for Copy
      const lines = [];
      const get = (k) => (card[k] || '').toString().trim();
      if(get('Professional Name')) lines.push(`Professional Name: ${get('Professional Name')}`);
      if(get('Legal Name'))        lines.push(`Legal Name: ${get('Legal Name')}`);
      if(get('Date of Birth'))     lines.push(`Date of Birth: ${get('Date of Birth')}`);
      if(get('TSA PreCheck® KTN')) lines.push(`TSA KTN: ${get('TSA PreCheck® KTN')}`);
      if(get('Travel Preferences')) lines.push(`Travel: ${get('Travel Preferences')}`);
      if(get('Food Allergies, Dietary Needs.')) lines.push(`Diet: ${get('Food Allergies, Dietary Needs.')}`);
      if(get('Panels and Workshops')){
        lines.push('Panels and Workshops:');
        lines.push(get('Panels and Workshops'));
      }
      const payload = esc(lines.join('\n'));

      return `
        <div class="col">
          <div class="card h-100">
            <div class="card-body d-flex flex-column">
              <div class="d-flex align-items-start justify-content-between gap-2 mb-2">
                <h2 class="h5 mb-0">${name}</h2>
                <button class="btn btn-sm btn-outline-secondary js-copy-card" type="button" aria-label="Copy details for ${name}">
                  <i class="bi bi-copy" aria-hidden="true"></i>
                </button>
              </div>
              <div class="small mb-2">${meta.join('')}</div>
              ${ panelsRaw ? `
                <details class="mt-auto">
                  <summary class="small">Panels and workshops</summary>
                  <div class="mt-2 small">${panels}</div>
                </details>
              ` : '' }
              <pre class="visually-hidden js-copy-payload">${payload}</pre>
            </div>
          </div>
        </div>`;
    }).join('');
    grid.innerHTML = html || '<div class="col-12"><div class="alert alert-info">No entries.</div></div>';
    grid.setAttribute('aria-busy','false');
    count.textContent = `${cards.length} actor${cards.length===1?'':'s'}`;
  }

  async function init(){
    const grid = document.getElementById('grid');
    const filter = document.getElementById('filter');
    const HIDE_ACTORS = [
      'Alex Cazares',
      'Kiba Walker',
      'John Gremillion',
      'Kent Williams',
      'Dusty Feeney',
      'Lara Woodhull',
      'Cole Feuchter',
      'Olivia Swasey',
      'Ashely Biski',
      'Jacob Eiseman',
      'Charlie Schlatter'
    ].map(normName);
    // one-time event delegation for read-more and copy button
    grid.addEventListener('click', (e) => {
      const a = e.target.closest('.js-read-more');
      if(a){
        e.preventDefault();
        const span = a.previousElementSibling;
        if(span){
          const full = span.getAttribute('data-full') || '';
          if(full) span.textContent = full;
        }
        a.remove();
        return;
      }

      const copyBtn = e.target.closest('.js-copy-card');
      if(copyBtn){
        const cardBody = copyBtn.closest('.card-body');
        const pre = cardBody && cardBody.querySelector('.js-copy-payload');
        const text = pre ? pre.textContent : '';
        if(!text){ return; }
        copyText(text)
          .then(()=>{
            copyBtn.classList.remove('btn-outline-secondary');
            copyBtn.classList.add('btn-success');
            setTimeout(()=>{
              copyBtn.classList.remove('btn-success');
              copyBtn.classList.add('btn-outline-secondary');
            }, 900);
          })
          .catch(()=>{
            copyBtn.classList.remove('btn-outline-secondary');
            copyBtn.classList.add('btn-danger');
            setTimeout(()=>{
              copyBtn.classList.remove('btn-danger');
              copyBtn.classList.add('btn-outline-secondary');
            }, 900);
          });
      }
    });
    try{
      const res = await fetch(encodeURI('Actors_Full_Details for cards.csv'));
      if(!res.ok) throw new Error(res.status + ' ' + res.statusText);
      const text = await res.text();
      const rows = parseCSV(text);
      const raw = toObjects(rows);
      const cards = mergeByActor(raw);
      const visible = cards.filter(c => !HIDE_ACTORS.includes(normName(c['Professional Name'])));
      render(visible);

      // filtering
      const norm = s => (s||'').toLowerCase();
      filter.addEventListener('input', (e)=>{
        const q = norm(e.target.value);
        const filtered = !q ? visible : visible.filter(c => norm(c['Professional Name']).includes(q));
        render(filtered);
      });
    }catch(err){
      grid.innerHTML = `<div class="col-12"><div class="alert alert-danger">Failed to load CSV: ${err.message || err}</div></div>`;
      grid.setAttribute('aria-busy','false');
      document.getElementById('count').textContent = 'Error';
    }
  }

  init();
  </script>
</body>
</html>
